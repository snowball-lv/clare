

// #define RULE(pattern, action)

RULE(Nodes.Seq(0, 0), {
    MUNCH(root->kids[0]);
    MUNCH(root->kids[1]);
})

RULE(Nodes.Mov(Nodes.Tmp(), 0), {
    VReg *dst = MUNCH(root->kids[0]);
    VReg *src = MUNCH(root->kids[1]);
    EMIT(OP({
        .fmt = "mov $vr, $vr\n",
        .oprs[0] = { .vreg = dst },
        .oprs[1] = { .vreg = src },
        .use = { src },
        .def = { dst }
    }));
})

RULE(Nodes.Tmp(), {
    return VRegForTmp(state, root);
})

RULE(Nodes.Add(0, 0), {
    VReg *left = MUNCH(root->kids[0]);
    VReg *right = MUNCH(root->kids[1]);
    EMIT(OP({
        .fmt = "add $vr, $vr\n",
        .oprs[0] = { .vreg = left },
        .oprs[1] = { .vreg = right },
        .use = { left, right },
        .def = { left }
    }));
    return left;
})

RULE(Nodes.I32(0), {
    VReg *dst = NewVReg();
    EMIT(OP({
        .fmt = "mov $vr, $i32\n",
        .oprs[0] = { .vreg = dst },
        .oprs[1] = { .i32 = root->i32 },
        .def = { dst }
    }));
    return dst;
})
