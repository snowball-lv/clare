
require_relative "rakefile-base"
require "pathname"

NAME = "clare"
DYN_LIB = "bin/#{NAME}.dll"

SRCS = FileList["src/**/*.c"]
OBJS = SRCS.pathmap("out/%X.o")

CFLAGS = [ "-c", "-I inc" ]
DYN_CFLAGS = CFLAGS + [ "-fPIC" ]

SRCS.zip(OBJS).each do |src, obj|
    make_compile_task(src, obj, DYN_CFLAGS)
end

LFLAGS = []
DYN_LFLAGS = LFLAGS + [ "-shared" ]
DEV_LFLAGS = LFLAGS + [ "-L bin", "-l #{NAME}" ]

make_link_task(DYN_LIB, OBJS, DYN_LFLAGS)

DEV_SRCS = FileList["dev/**/*.c"]
DEV_OBJS = DEV_SRCS.pathmap("out/%X.o")
DEV_BINS = DEV_SRCS.pathmap("%X").map do |path|
    name = Pathname(path).each_filename.to_a.join("-")
    File.join("bin", name)
end

DEV_SRCS.zip(DEV_OBJS).each do |src, obj|
    make_compile_task(src, obj, CFLAGS)
end

DEV_BINS.zip(DEV_OBJS).each do |bin, obj|
    file(bin => DYN_LIB)
    make_link_task(bin, [ obj ], DEV_LFLAGS)
end

# task :default => DYN_LIB
task :default => DEV_BINS do
    run_tests(DEV_BINS)
end

task :clean do
    rm_rf "out"
    rm_rf "bin"
end
